<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Handshake &mdash; Wiki  documentation</title>
      <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/css/custom.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/css/algolia.css" type="text/css" />
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/doctools.js"></script>
        <script src="../../../../_static/sphinx_highlight.js"></script>
        <script src="../../../../_static/js/external-hyperlinks.js"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link rel="next" title="IPE" href="IPE.html" />
    <link rel="prev" title="Synchronization" href="index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../index.html" class="icon icon-home">
            Wiki
              <img src="https://raw.githubusercontent.com/Metin2-Dev/Assets/main/128_round_black.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Wiki</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">Topics</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../Encryption/index.html">Encryption</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../Encryption/hybrid_cript.html">HybridCrypt (Type 4)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../Encryption/hybrid_cript.html#summary">Summary</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../Encryption/hybrid_cript.html#distinction">Distinction</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../Encryption/hybrid_cript.html#usage">Usage</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../Encryption/hybrid_cript.html#composition">Composition</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../Encryption/hybrid_cript_plus.html">HybridCrypt+ (Type 5)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../Encryption/hybrid_cript_plus.html#summary">Summary</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../Encryption/hybrid_cript_plus.html#distinction">Distinction</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../Encryption/hybrid_cript_plus.html#composition">Composition</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../Formats/index.html">Formats</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../Formats/Map/index.html">Map</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../Formats/Map/Chunk/index.html">Chunk</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../Formats/Map/index.html#directory-composition">Directory Composition</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../Formats/Scripts/index.html">Script</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../Formats/Scripts/Base.html">Script Format</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../Formats/Scripts/Property.html">Property</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../Formats/Scripts/Sub.html">Sub Format (.sub)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../Formats/Entity/index.html">Entity</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../Formats/Entity/Models/index.html">Models</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../Formats/Entity/Motion.html">Motion Data</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../Formats/Entity/Effect.html">Effect Data</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../Formats/Entity/Sound.html">Sound Data</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../Formats/Pack/index.html">Pack</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../Formats/Pack/eter.html">EterPack</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../Formats/Protos/index.html">Protos</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../Formats/Protos/Item.html">Item Proto</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../Formats/Protos/Mob.html">Mob Proto</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../Formats/Deprecated/index.html">Deprecated</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../Formats/Deprecated/texture_caching.html">DDS Texture Caching</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../Formats/Encrypted-Object.html">Encrypted Object</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../Formats/Encrypted-Object.html#header">Header</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../Formats/Encrypted-Object.html#data-compression">Data Compression</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../Formats/Encrypted-Object.html#data-encryption">Data Encryption</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html">Networking</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../Flow.html">Flow</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../Flow.html#concept">Concept</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../Phases.html">Phases</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../Phases.html#login-phase">Login Phase</a></li>
</ul>
</li>
<li class="toctree-l3 current"><a class="reference internal" href="index.html">Synchronization</a><ul class="current">
<li class="toctree-l4 current"><a class="current reference internal" href="#">Handshake</a></li>
<li class="toctree-l4"><a class="reference internal" href="IPE.html">IPE</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../Data/index.html">Data</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../Data/Packets/index.html">Packets</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../Encryption/index.html">Encryption</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../Encryption/Overview.html">Encryption</a></li>
<li class="toctree-l4"><a class="reference internal" href="../Encryption/Encryption.html">Network Encryption</a></li>
<li class="toctree-l4"><a class="reference internal" href="../Encryption/IPE.html">IPE</a></li>
<li class="toctree-l4"><a class="reference internal" href="../Encryption/XTEA.html">XTEA</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">About</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../About/index.html">About</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../About/Contributing.html">Contributing</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../About/Contributing.html#requirements">Requirements</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../About/Contributing.html#content">Content</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../About/Contributing.html#proposing-changes">Proposing Changes</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../About/Contributing.html#pull-requests-approval">Pull Requests / Approval</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../About/Contributing.html#licensing">Licensing</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">Wiki</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Topics</a></li>
          <li class="breadcrumb-item"><a href="../index.html">Networking</a></li>
          <li class="breadcrumb-item"><a href="index.html">Synchronization</a></li>
      <li class="breadcrumb-item active">Handshake</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/Metin2-Dev/wiki-beta-dev/blob/beta/docs/pages/Topics/Networking/Synchronization/Handshake.md" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="handshake">
<h1>Handshake<a class="headerlink" href="#handshake" title="Permalink to this heading"></a></h1>
<p>A Handshake is the standard synchrony integrity verification, it is used
to make sure that agents communicating with each other are valid and aware
of phase states, encryption and time synchronization</p>
<p>It is always used first before data incoming to the game or authentication
agent can be accepted, and it is also performed when a phase change occurs</p>
<section id="shaking">
<h2>Shaking<a class="headerlink" href="#shaking" title="Permalink to this heading"></a></h2>
<p>To perform a handshake, the server generates a <em>Hand</em> which we are
going to call the <code class="docutils literal notranslate"><span class="pre">right</span> <span class="pre">hand</span></code>, gets it current time and a time delta (used for
synchronizing the time with the other agent) and puts it in a
<a class="reference internal" href="../Data/Packets/Handshake.html"><span class="std std-doc">Handshake</span></a> packet</p>
<p>It stores the hand and after that it sends it to the other agent and in the
<strong>next instruction</strong>, stores the current time and flags that a handshake
is happening, so that it can be used later for validation and synchronization</p>
<p>When the packet is received by the client agent, it generates a <em>Hand</em>
which we will call the <code class="docutils literal notranslate"><span class="pre">left</span> <span class="pre">hand</span></code>, stores the received server time contained
in the packet, creates a new equally formatted Handshake packet, puts the left
hand in it and sends it to the server agent</p>
<p>When the server agent receives it, checks if the hand is still the same as the
one that was last sent, if it isn’t the connection is terminated</p>
<p>Next it checks if it is in the Handshake Phase, if so it will validate if the
time between shakes is valid and synchronized, the process is explained below</p>
<p>If it is valid and synchronized, other synchronizations are perform, like the
<a class="reference internal" href="IPE.html"><span class="std std-doc">IPE</span></a></p>
</section>
<section id="synchronization-validation">
<h2>Synchronization validation<a class="headerlink" href="#synchronization-validation" title="Permalink to this heading"></a></h2>
<p>First it will start by checking if the received time delta from the packet
is below 0, if so it will return as invalid</p>
<p>Then it will check the time difference, adding the received Handshake packet’s
time and delta and subtracting to the current server time, for example:
<code class="docutils literal notranslate"><span class="pre">current_server_time</span> <span class="pre">-</span> <span class="pre">handshake_packet_time</span> <span class="pre">+</span> <span class="pre">handshake_packet_delta</span></code></p>
<p>Then it will check if the result is inbetween a range, by default is from <code class="docutils literal notranslate"><span class="pre">0</span></code>
to <code class="docutils literal notranslate"><span class="pre">50</span></code>, and if it is it means the handshake is valid, so it will store
the current time as the client agent’s time and set the handshake as done</p>
<p>Otherwise, if it is not in the range, the server agent will generate a new
delta by getting the current server time and subtracting it to the Handshake
packet time, then divided by two, for example:
<code class="docutils literal notranslate"><span class="pre">(current_server_time</span> <span class="pre">-</span> <span class="pre">handshake_packet_time)</span> <span class="pre">/</span> <span class="pre">2</span></code></p>
<p>Then it will increase the retry count by one and send it to the client
and the same process as since the whole beginning will occur, it will store
the time of when the packet was sent, the client will send it back to the
server, then validate and so on…</p>
<p>There is a limit for how many times this process can be retried,
by default its <code class="docutils literal notranslate"><span class="pre">32</span></code> times, but depends on the server settings for this
option</p>
</section>
<section id="hand-generation">
<h2>Hand generation<a class="headerlink" href="#hand-generation" title="Permalink to this heading"></a></h2>
<p>The hand is a pseudo random number from <code class="docutils literal notranslate"><span class="pre">0</span></code> to <code class="docutils literal notranslate"><span class="pre">4.294.967.295</span></code>
(the range of a 32-bit unsigned integer)</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="index.html" class="btn btn-neutral float-left" title="Synchronization" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="IPE.html" class="btn btn-neutral float-right" title="IPE" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2018-2023.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>